<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bainzuretta V62.2</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bainzuretta">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/AlleRock/bainzuretta/main/icona.png">
    
    <link rel="manifest" href="manifest.json">

    <style>
        :root { --primary: #fb8c00; --bg: #f0f2f5; --card: #ffffff; --text: #111111; --border: #888888; }
        @media (prefers-color-scheme: dark) { :root { --bg: #000000; --card: #1c1c1e; --text: #ffffff; --border: #444444; } }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: 900; text-transform: uppercase; }
        .page { display: none; padding: 12px; width: 100%; max-width: 500px; margin: 0 auto; }
        .page.active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 15px; }
        .target-box { background: linear-gradient(135deg, #fb8c00, #f57c00); color: white; text-align: center; cursor: pointer; }
        input, select { width: 100%; height: 45px; padding: 0 10px; border: 2px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text); font-size: 16px; -webkit-appearance: none; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 900; width: 100%; cursor: pointer; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: rgba(251, 140, 0, 0.1); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid var(--primary); }
        .stat-box b { font-size: 1.1em; color: var(--primary); }
        .rank-item { padding: 10px; background: var(--card); border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
        .rank-info { display: flex; justify-content: space-between; font-weight: 800; font-size: 0.82em; align-items: center; gap: 2px; }
        .progress-bg { background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 6px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; transition: width 0.5s; }
        
        nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: var(--card); display: flex; border-top: 1px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        nav div { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #888; font-size: 10px; flex-direction: column; }
        nav div.active { color: var(--primary); border-top: 4px solid var(--primary); }
        
        .btn-del { background: #ff3b30; color: white; border: none; padding: 5px 7px; border-radius: 6px; font-size: 10px; }
        .btn-edit { background: #007aff; color: white; border: none; padding: 5px 7px; border-radius: 6px; font-size: 10px; }

        /* Grafico */
        .chart-container { width: 100%; height: 260px; position: relative; margin-top: 10px; }
        .legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 15px; font-size: 10px; font-weight: bold; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<header id="main-header">BAINZURETTA</header>

<div id="home" class="page active">
    <div class="card target-box" onclick="cambiaObiettivo()">
        <small>üöÄ OBIETTIVO <span class="year-label"></span></small><br>
        <b id="km-mancanti" style="font-size: 2em;">0</b> <small>KM AL TRAGUARDO</small>
        <div style="margin-top:8px; border-top:1px solid rgba(255,255,255,0.3); padding-top:8px; font-size:0.75em;">
            Target: <b id="val-target-tot">5000</b> | Proiezione: <b id="val-proiezione">0</b> | <b id="val-week">0</b> KM/SETT
        </div>
    </div>
    <div class="card"><div class="stats-grid"><div class="stat-box" style="grid-column: span 2;"><small>TOTALE KM STORICI</small><br><b id="st-km">0</b></div><div class="stat-box"><small>GIRI DEL MONDO</small><br><b id="st-world">0.00</b></div><div class="stat-box"><small>TOP MEDIA ANNO</small><br><b id="st-speed">0.00</b></div></div></div>
    <div class="card">
        <h3 id="form-title" style="color:var(--primary); font-size: 0.8em; margin-bottom: 10px;">‚ûï AGGIUNGI ATTIVIT√Ä</h3>
        <input type="date" id="in-date" style="margin-bottom:10px;">
        <input type="number" step="0.01" id="in-dist" placeholder="KM" style="margin-bottom:10px;">
        <input type="text" id="in-time" placeholder="HH:MM:SS" style="margin-bottom:10px;">
        <input type="number" step="0.01" id="in-kmh" placeholder="KM/H" style="margin-bottom:15px;">
        <button class="btn-add" id="btn-save" onclick="salvaManuale()">SALVA</button>
    </div>
    <div class="card" style="text-align:center;">
        <p style="font-size: 10px; color: #888; margin-bottom: 10px;">GESTIONE DATI JSON</p>
        <input type="file" id="json-input" accept=".json" style="font-size: 11px; margin-bottom:10px; width: 100%;">
        <button onclick="esportaJSON()" style="background:#444; color:white; border:none; padding:10px; border-radius:10px; width:100%; font-weight:bold; font-size: 11px; margin-bottom: 5px;">üì¶ BACKUP JSON</button>
        <button onclick="pulisciTutto()" style="background:#ff3b30; color:white; border:none; padding:10px; border-radius:10px; width:100%; font-weight:bold; font-size: 11px;">üóëÔ∏è RESET DATI</button>
    </div>
</div>

<div id="diario" class="page">
    <div class="card" style="text-align:center;"><h3 style="margin:0; font-size: 1em;">üìñ DIARIO <span class="year-label"></span></h3></div>
    <div id="lista-diario"></div>
</div>

<div id="ranking" class="page">
    <div class="card" style="text-align:center;">
        <h3 style="margin:0; font-size: 1em;">üèÜ RANKING YTD</h3>
        <select id="metrica" onchange="disegnaClassifica()" style="margin-top:10px;">
            <option value="distanza">Distanza Totale (KM)</option>
            <option value="ponderata">Media Ponderata (KM Tot / Ore Tot)</option>
            <option value="media">Media Semplice (KM/H)</option>
        </select>
    </div>
    <div id="lista-ranking"></div>
</div>

<div id="grafici" class="page">
    <div class="card" style="text-align:center;">
        <h3 style="margin:0; font-size: 1em;">üìà TREND MEDIE PROGRESSIVE</h3>
        <p style="font-size: 10px; color: #888; margin-bottom: 10px;">Media YTD: Top 3 Anni vs <span class="year-label"></span></p>
        <div id="container-svg" class="chart-container"></div>
        <div id="legenda-grafico" class="legend"></div>
    </div>
</div>

<nav>
    <div id="nav-home" class="active" onclick="vaiA('home')">üè†<span>HOME</span></div>
    <div id="nav-diario" onclick="vaiA('diario')">üìñ<span>DIARIO</span></div>
    <div id="nav-rank" onclick="vaiA('ranking')">üèÜ<span>RANK</span></div>
    <div id="nav-grafici" onclick="vaiA('grafici')">üìà<span>GRAFICI</span></div>
</nav>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(err => {});
    }

    let rawData = [];
    const oggi = new Date();
    const currY = oggi.getFullYear();
    let myTarget = parseInt(localStorage.getItem('bainzuretta_target_' + currY)) || 5000;
    const doyOggi = Math.floor((oggi - new Date(currY, 0, 0)) / 86400000);

    window.onload = () => {
        document.getElementById('main-header').innerText = "BAINZURETTA " + currY;
        document.querySelectorAll('.year-label').forEach(el => el.innerText = currY);
        const s = localStorage.getItem('bainzuretta_raw');
        if (s) { rawData = JSON.parse(s); aggiornaStats(); }
        document.getElementById('val-target-tot').innerText = myTarget;
        document.getElementById('in-date').valueAsDate = oggi;
    };

    function tempoDecimale(v) {
        if(!v) return 0;
        let s = v.toString().replace(',','.').trim();
        if(s.includes(':')) {
            let p = s.split(':');
            return parseInt(p[0]) + (parseInt(p[1])/60) + (p[2]?parseInt(p[2])/3600:0);
        }
        return parseFloat(s) || 0;
    }

    function formattaTempo(oreDec) {
        let h = Math.floor(oreDec);
        let m = Math.floor((oreDec - h) * 60);
        let s = Math.round(((oreDec - h) * 60 - m) * 60);
        return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function aggiornaStats() {
        let totK = 0, kY = 0;
        let pAnni = {};
        rawData.forEach(a => {
            let dist = parseFloat(a.distanza) || 0;
            let med = parseFloat(a.media) || 0;
            let y = new Date(a.data).getFullYear();
            totK += dist;
            if(y === currY) kY += dist;
            if(!pAnni[y]) pAnni[y] = { mSum: 0, count: 0 };
            if(med > 0) { pAnni[y].mSum += med; pAnni[y].count++; }
        });
        document.getElementById('st-km').innerText = totK.toLocaleString('it-IT', {minimumFractionDigits:2}) + " KM";
        document.getElementById('st-world').innerText = (totK / 40075).toFixed(2);
        
        let maxAvg = 0, bestY = "-";
        Object.keys(pAnni).forEach(y => {
            if(pAnni[y].count > 0) {
                let avg = pAnni[y].mSum / pAnni[y].count;
                if(avg > maxAvg) { maxAvg = avg; bestY = y; }
            }
        });
        document.getElementById('st-speed').innerHTML = maxAvg.toFixed(2) + ` <small>km/h (${bestY})</small>`;
        const mancanti = Math.max(0, myTarget - kY);
        document.getElementById('km-mancanti').innerText = mancanti.toLocaleString('it-IT');
        document.getElementById('val-proiezione').innerText = Math.round((kY / Math.max(1, doyOggi)) * 365).toLocaleString('it-IT');
        const giorniRimanenti = Math.max(1, 365 - doyOggi);
        const settRimanenti = giorniRimanenti / 7;
        document.getElementById('val-week').innerText = Math.ceil(mancanti / settRimanenti);
    }

    function disegnaClassifica() {
        const m = document.getElementById('metrica').value;
        const container = document.getElementById('lista-ranking');
        container.innerHTML = "";
        let p = {};
        rawData.forEach(a => {
            let dt = new Date(a.data);
            let y = dt.getFullYear();
            if(!p[y]) p[y] = { d:0, tSum:0, mSum:0, c:0 };
            let doyA = Math.floor((dt - new Date(y, 0, 0)) / 86400000);
            if(doyA <= doyOggi) {
                let dist = parseFloat(a.distanza) || 0;
                let med = parseFloat(a.media) || 0;
                p[y].d += dist;
                p[y].mSum += med;
                p[y].c++;
                p[y].tSum += (med > 0 ? dist / med : 0);
            }
        });
        let s = Object.keys(p).sort((a,b) => {
            if(m==='distanza') return p[b].d - p[a].d;
            if(m==='ponderata') return (p[b].d / (p[b].tSum || 1)) - (p[a].d / (p[a].tSum || 1));
            return (p[b].mSum / (p[b].c || 1)) - (p[a].mSum / (p[a].c || 1));
        });
        let maxVal = s.length ? Math.max(...s.map(y => {
            if(m==='distanza') return p[y].d;
            if(m==='ponderata') return (p[y].d / (p[y].tSum || 1));
            return (p[y].mSum / (p[y].c || 1));
        })) : 1;
        s.forEach((y, i) => {
            let val = m==='distanza' ? p[y].d : m==='ponderata' ? (p[y].d / (p[y].tSum || 1)) : (p[y].mSum / (p[y].c || 1));
            let unit = m==='distanza' ? " km" : " km/h";
            container.innerHTML += `<div class="rank-item"><div class="rank-info"><span>${i+1}. ${y}</span><span style="color:var(--primary)">${val.toFixed(2)}${unit}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${(val/maxVal)*100}%"></div></div></div>`;
        });
    }

    function disegnaGrafici() {
        const container = document.getElementById('container-svg');
        const legend = document.getElementById('legenda-grafico');
        container.innerHTML = ""; legend.innerHTML = "";

        let statsMap = {}; 
        rawData.forEach(a => {
            let dt = new Date(a.data);
            let y = dt.getFullYear();
            let m = dt.getMonth();
            if(!statsMap[y]) statsMap[y] = Array(12).fill(null).map(() => ({dist:0, ore:0}));
            let dist = parseFloat(a.distanza) || 0;
            let med = parseFloat(a.media) || 0;
            if(med > 0) {
                statsMap[y][m].dist += dist;
                statsMap[y][m].ore += (dist / med);
            }
        });

        let yearStats = Object.keys(statsMap).filter(y => parseInt(y) !== currY).map(y => {
            let dTot = statsMap[y].reduce((s, m) => s + m.dist, 0);
            let oTot = statsMap[y].reduce((s, m) => s + m.ore, 0);
            return {y, avg: oTot > 0 ? dTot / oTot : 0};
        }).sort((a,b) => b.avg - a.avg).slice(0,3).map(obj => obj.y);

        let yearsToShow = [...yearStats];
        if(statsMap[currY]) yearsToShow.push(currY.toString());

        const colors = ["#2ecc71", "#3498db", "#9b59b6", "#fb8c00"]; 
        let minMed = 15, maxMed = 40; 
        const W = container.clientWidth, H = 260, padding = 30;

        let svg = `<svg viewBox="0 0 ${W} ${H}" style="width:100%; height:100%;">`;
        for(let i=0; i<=5; i++) {
            let yVal = maxMed - (i * (maxMed-minMed)/5);
            let yPos = padding + (i * (H - 2*padding)/5);
            svg += `<line x1="${padding}" y1="${yPos}" x2="${W-padding}" y2="${yPos}" stroke="#888" stroke-dasharray="2" opacity="0.3" />`;
            svg += `<text x="5" y="${yPos+4}" font-size="10" fill="#888">${yVal}</text>`;
        }

        yearsToShow.forEach((year, idx) => {
            let isCurr = (year == currY);
            let color = isCurr ? colors[3] : colors[idx];
            let points = [];
            let cumDist = 0, cumOre = 0;

            statsMap[year].forEach((m, i) => {
                cumDist += m.dist;
                cumOre += m.ore;

                if(cumOre > 0) {
                    if(isCurr && m.dist === 0 && m.ore === 0 && i > (new Date().getMonth())) return;

                    let avgProgressiva = cumDist / cumOre;
                    let x = padding + (i * (W - 2*padding)/11);
                    let y = padding + (maxMed - avgProgressiva) * (H - 2*padding) / (maxMed - minMed);
                    y = Math.max(padding, Math.min(H - padding, y));
                    
                    points.push(`${x},${y}`);
                    svg += `<circle cx="${x}" cy="${y}" r="${isCurr ? 3.5 : 2}" fill="${color}" />`;
                }
            });

            if(points.length > 1) {
                let dash = (idx === 2 && !isCurr) ? 'stroke-dasharray="4 2"' : '';
                svg += `<polyline points="${points.join(' ')}" fill="none" stroke="${color}" stroke-width="${isCurr ? 3.5 : 2}" ${dash} ${!isCurr ? 'opacity="0.75"' : ''} />`;
            }
            legend.innerHTML += `<div class="legend-item"><div class="dot" style="background:${color}; ${idx === 2 && !isCurr ? 'border-radius:2px;' : ''}"></div> ${year}</div>`;
        });

        ["G","F","M","A","M","G","L","A","S","O","N","D"].forEach((m, i) => {
            let x = padding + (i * (W - 2*padding)/11);
            svg += `<text x="${x-3}" y="${H-5}" font-size="10" fill="#888">${m}</text>`;
        });
        svg += `</svg>`;
        container.innerHTML = svg;
    }

    function salvaManuale() {
        const d = document.getElementById('in-date').value, k = parseFloat(document.getElementById('in-dist').value);
        if(!d || isNaN(k)) return;
        let t = tempoDecimale(document.getElementById('in-time').value);
        let med = parseFloat(document.getElementById('in-kmh').value) || (k/t);
        rawData.push({ id: Date.now(), data: new Date(d).toISOString(), distanza: k, tempo: t, media: med });
        localStorage.setItem('bainzuretta_raw', JSON.stringify(rawData));
        location.reload();
    }

    function preparaModifica(id) {
        const a = rawData.find(x => x.id === id);
        if(!a) return;
        vaiA('home');
        document.getElementById('form-title').innerText = "‚úèÔ∏è MODIFICA ATTIVIT√Ä";
        document.getElementById('btn-save').innerText = "AGGIORNA";
        document.getElementById('in-date').value = a.data.split('T')[0];
        document.getElementById('in-dist').value = a.distanza;
        document.getElementById('in-time').value = formattaTempo(a.tempo);
        document.getElementById('in-kmh').value = a.media;
        rawData = rawData.filter(x => x.id !== id);
    }

    function esportaJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(rawData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "bainzuretta_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    document.getElementById('json-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            rawData = JSON.parse(new TextDecoder().decode(ev.target.result));
            localStorage.setItem('bainzuretta_raw', JSON.stringify(rawData));
            location.reload();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function vaiA(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav div').forEach(n => n.classList.remove('active'));
        document.getElementById('nav-'+id).classList.add('active');
        if(id === 'ranking') disegnaClassifica();
        if(id === 'diario') disegnaDiario();
        if(id === 'grafici') disegnaGrafici();
    }

    function disegnaDiario() {
        const c = document.getElementById('lista-diario'); c.innerHTML = "";
        const lista = rawData.filter(a => new Date(a.data).getFullYear() === currY).sort((a,b) => new Date(b.data) - new Date(a.data));
        lista.forEach(a => {
            let sep = `<span style="color:var(--text); opacity:0.4; margin:0 2px;">|</span>`;
            let rigaDati = `<b>${parseFloat(a.distanza).toFixed(1)}</b>km${sep}<b>${formattaTempo(a.tempo)}</b>${sep}<b>${parseFloat(a.media).toFixed(1)}</b>km/h`;
            c.innerHTML += `<div class="rank-item"><div class="rank-info"><span>${new Date(a.data).toLocaleDateString('it-IT', {day:'2-digit', month:'2-digit'})}</span><span style="color:var(--primary);">${rigaDati}</span><div style="display:flex; gap:2px;"><button class="btn-edit" onclick="preparaModifica(${a.id})">‚úèÔ∏è</button><button class="btn-del" onclick="eliminaAttivita(${a.id})">X</button></div></div></div>`;
        });
    }

    function eliminaAttivita(id) { if(confirm("Elimina?")) { rawData = rawData.filter(a => a.id !== id); localStorage.setItem('bainzuretta_raw', JSON.stringify(rawData)); location.reload(); } }
    function pulisciTutto() { if(confirm("CANCELLARE TUTTO?")) { localStorage.clear(); location.reload(); } }
    function cambiaObiettivo() { let n = prompt("Target per il " + currY + ":", myTarget); if(n) { myTarget = parseInt(n); localStorage.setItem('bainzuretta_target_' + currY, n); location.reload(); } }
</script>
</body>
</html>
