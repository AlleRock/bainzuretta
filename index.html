<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bainzuretta - Bike Stats</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #e67e22; --dark: #2c3e50; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--dark); }
        nav { display: flex; background: var(--dark); color: white; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        nav div { flex: 1; text-align: center; padding: 18px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8em; }
        nav div.active { background: var(--primary); }
        .page { display: none; padding: 20px; max-width: 600px; margin: auto; }
        .page.active { display: block; }
        h1 { text-align: center; color: var(--dark); }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        input[type="file"] { border: 2px dashed #ddd; padding: 30px; width: 100%; box-sizing: border-box; border-radius: 10px; text-align: center; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 10px; overflow: hidden; }
        th { background: #eee; padding: 15px 10px; text-align: left; }
        td { padding: 15px 10px; border-bottom: 1px solid #f0f0f0; }
        tr.rank-1 { background: #fff8e1; font-weight: bold; color: #f39c12; }
    </style>
</head>
<body>
<nav>
    <div id="btn-1" class="active" onclick="showPage(1)">Inserimento</div>
    <div id="btn-2" onclick="showPage(2)">Classifica YTD</div>
</nav>
<div id="page1" class="page active">
    <h1>Bainzuretta</h1>
    <div class="card">
        <p style="text-align:center">Carica il file <strong>Bainzuretta Activities.xlsx</strong></p>
        <input type="file" id="excel-input" accept=".xlsx">
        <p id="status" style="text-align:center; color: #27ae60; font-weight: bold;"></p>
    </div>
</div>
<div id="page2" class="page">
    <h1>Confronto YTD</h1>
    <p style="text-align:center; color: #7f8c8d;">Dati al <strong id="current-date-display">...</strong> di ogni anno</p>
    <div class="card">
        <label>Ordina classifica per:</label>
        <select id="metric-select" onchange="renderRanking()">
            <option value="distanza">Distanza Totale (km)</option>
            <option value="tempo">Tempo Totale (ore)</option>
            <option value="media">Velocità Media (km/h)</option>
        </select>
    </div>
    <table>
        <thead><tr><th>Pos</th><th>Anno</th><th id="metric-label">Distanza</th></tr></thead>
        <tbody id="ranking-body"></tbody>
    </table>
</div>
<script>
    let db = {};
    function showPage(n) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
        document.getElementById('page'+n).classList.add('active');
        document.getElementById('btn-'+n).classList.add('active');
    }
    function timeToDecimal(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return 0;
        const parts = timeStr.split(':');
        return parseInt(parts[0]) + (parseInt(parts[1])/60) + (parseInt(parts[2])/3600);
    }
    document.getElementById('excel-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            processWorkbook(wb);
            document.getElementById('status').innerText = "✅ Dati caricati correttamente!";
        };
        reader.readAsArrayBuffer(file);
    });
    function processWorkbook(wb) {
        const today = new Date();
        const tDay = today.getDate();
        const tMonth = today.getMonth();
        db = {};
        wb.SheetNames.forEach(sheetName => {
            const data = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {range: 9});
            let totalDist = 0, totalTimeDec = 0, speedSum = 0, count = 0;
            data.forEach(row => {
                const rawDate = row["DATA DELL'ATTIVITÀ"];
                if(!rawDate) return;
                const parts = rawDate.split(' ');
                const d = parseInt(parts[1]);
                const mStr = parts[2] ? parts[2].toLowerCase() : "";
                const months = ["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];
                const m = months.indexOf(mStr);
                if (m < tMonth || (m === tMonth && d <= tDay)) {
                    totalDist += parseFloat(row["DISTANZA"] || 0);
                    totalTimeDec += timeToDecimal(row["TEMPO IN MOVIMENTO"]);
                    speedSum += parseFloat(row["KM/H"] || 0);
                    count++;
                }
            });
            if (count > 0) { db[sheetName] = { distanza: totalDist, tempo: totalTimeDec, media: speedSum / count }; }
        });
        document.getElementById('current-date-display').innerText = today.toLocaleDateString('it-IT', {day:'numeric', month:'long'});
        renderRanking();
    }
    function renderRanking() {
        const metric = document.getElementById('metric-select').value;
        const body = document.getElementById('ranking-body');
        const units = { distanza: 'km', tempo: 'h', media: 'km/h' };
        body.innerHTML = "";
        const sortedYears = Object.keys(db).sort((a, b) => db[b][metric] - db[a][metric]);
        sortedYears.forEach((year, i) => {
            const tr = document.createElement('tr');
            if(i === 0) tr.className = 'rank-1';
            tr.innerHTML = `<td>${i+1}</td><td>${year}</td><td>${db[year][metric].toFixed(2)} ${units[metric]}</td>`;
            body.appendChild(tr);
        });
    }
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
</script>
</body>
</html>
